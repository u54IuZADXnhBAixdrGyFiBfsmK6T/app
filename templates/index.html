<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fitness Planner | Gemini</title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«: Noto Sansã‚’å„ªå…ˆ */
        body {
            font-family: "Inter", "Noto Sans JP", sans-serif;
            background-color: #f8fafc; /* ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ã®èƒŒæ™¯ */
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆææ¡ˆéƒ¨åˆ†ï¼‰ */
        #output-content::-webkit-scrollbar {
            width: 8px;
        }
        #output-content::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 4px;
        }
        #output-content::-webkit-scrollbar-track {
            background-color: #e2e8f0;
        }
        /* ã‚³ãƒ³ãƒ†ãƒŠã®å¹…ã‚’èª¿æ•´ */
        .container {
            max-width: 800px;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center items-start min-h-screen">

    <div class="container w-full bg-white rounded-xl shadow-2xl overflow-hidden my-8">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-gradient-to-r from-blue-600 to-cyan-500 p-6 text-white text-center rounded-t-xl">
            <h1 class="text-3xl font-extrabold flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-10a1 1 0 011-1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0V9a1 1 0 011-1zm0 5a1 1 0 100 2h2a1 1 0 100-2h-2z" clip-rule="evenodd" />
                    <path d="M10 2a8 8 0 00-6.15 13.5l-1.5 1.5a.5.5 0 00.7.7l1.5-1.5A8 8 0 0110 2z" clip-rule="evenodd" fill-rule="evenodd" />
                </svg>
                AIãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼
            </h1>
            <p class="mt-1 text-sm opacity-90">GeminiãŒã‚ãªãŸã®ç›®æ¨™ã«åˆã‚ã›ãŸæœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
        </header>

        <main class="p-6 sm:p-10">
            <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <section class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ç¾åœ¨ã®æƒ…å ±ã¨ç›®æ¨™</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="height" class="block text-sm font-medium text-gray-700 mb-1">ç¾åœ¨ã®èº«é•· (cm)</label>
                        <input type="number" id="height" value="170" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">ç¾åœ¨ã®ä½“é‡ (kg)</label>
                        <input type="number" id="weight" value="65" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="mt-4">
                    <label for="activity" class="block text-sm font-medium text-gray-700 mb-1">æ—¥å¸¸ç”Ÿæ´»ã®éã”ã—æ–¹ï¼ˆä¾‹ï¼šãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯ã€é€±3å›ã‚¸ãƒ ï¼‰</label>
                    <textarea id="activity" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 h-20 resize-none" placeholder="ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯ä¸­å¿ƒã§ã€é‹å‹•ã¯ã‚ã¾ã‚Šã—ã¦ã„ã¾ã›ã‚“ã€‚"></textarea>
                </div>

                <div class="mt-4">
                    <label for="ideal" class="block text-sm font-medium text-gray-700 mb-1">ç†æƒ³ã®ä½“å‹ãƒ»ç›®æ¨™ï¼ˆä¾‹ï¼šä½“è„‚è‚ªã‚’è½ã¨ã—ãŸã„ã€ç­‹è‚‰ã‚’ã¤ã‘ãŸã„ï¼‰</label>
                    <textarea id="ideal" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 h-20 resize-none" placeholder="ç­‹è‚‰ã‚’æ®‹ã—ãªãŒã‚‰ã€è„‚è‚ªã‚’è½ã¨ã—ãŸã„ã§ã™"></textarea>
                </div>
                
                <button onclick="getRecommendation()" id="submit-button" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-[1.01] shadow-lg shadow-blue-500/50 flex items-center justify-center">
                    <span id="button-text">ğŸ’ª æœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã™ã‚‹</span>
                    <div id="loading-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-2 border-t-2 border-white ml-2"></div>
                </button>
            </section>

            <!-- å‡ºåŠ›ã‚¨ãƒªã‚¢ -->
            <section class="mt-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ“… AIã«ã‚ˆã‚‹ææ¡ˆ</h2>
                <div id="output" class="bg-white p-4 sm:p-6 rounded-lg border border-gray-300 min-h-[150px] overflow-hidden">
                    <p class="text-gray-500 text-center py-8" id="initial-message">
                        å…¥åŠ›é …ç›®ã‚’åŸ‹ã‚ã¦ã€Œæœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <div id="output-content" class="text-gray-700 text-sm overflow-y-auto max-h-[60vh] whitespace-pre-wrap">
                        <!-- Geminiã‹ã‚‰ã®ææ¡ˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">â€»ææ¡ˆã¯AIã«ã‚ˆã‚‹ã‚‚ã®ã§ã‚ã‚Šã€åŒ»å­¦çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¿…ãšå°‚é–€å®¶ã®æ„è¦‹ã‚‚ã”å‚ç…§ãã ã•ã„ã€‚</p>
            </section>
        </main>
    </div>

    <script>
        // ----------------------------------------------------------------------------------
        // Gemini APIè¨­å®š
        // ----------------------------------------------------------------------------------
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; // Canvasç’°å¢ƒã§è‡ªå‹•çš„ã«æä¾›ã•ã‚Œã¾ã™
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        
        // ----------------------------------------------------------------------------------
        // UIæ“ä½œ
        // ----------------------------------------------------------------------------------
        const outputDiv = document.getElementById('output-content');
        const initialMessage = document.getElementById('initial-message');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        function setLoadingState(isLoading) {
            submitButton.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'ãƒ—ãƒ©ãƒ³ç”Ÿæˆä¸­...';
                loadingSpinner.classList.remove('hidden');
                submitButton.classList.add('opacity-70', 'cursor-not-allowed');
                outputDiv.innerHTML = '<p class="text-center p-4 text-blue-600 font-semibold">GeminiãŒã‚ãªãŸã®æƒ…å ±ã‚’åˆ†æã—ã¦ã„ã¾ã™...</p>';
                initialMessage.classList.add('hidden');
            } else {
                buttonText.textContent = 'ğŸ’ª æœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã™ã‚‹';
                loadingSpinner.classList.add('hidden');
                submitButton.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        // ----------------------------------------------------------------------------------
        // Gemini APIå‘¼ã³å‡ºã—ã¨ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------------------------------------
        async function getRecommendation() {
            const height = document.getElementById('height').value;
            const weight = document.getElementById('weight').value;
            const activity = document.getElementById('activity').value;
            const ideal = document.getElementById('ideal').value;

            if (!height || !weight || !activity || !ideal) {
                alertUser('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½¿ç”¨
                return;
            }

            setLoadingState(true);

            // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
            const systemPrompt = "ã‚ãªãŸã¯ãƒ—ãƒ­ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã§ã‚ã‚Šã€æ „é¤Šå£«ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã«åŸºã¥ãã€å®Ÿç¾å¯èƒ½ã§å…·ä½“çš„ãª1é€±é–“ã®çŒ®ç«‹ï¼ˆ3é£Ÿï¼‰ã¨ã€åˆå¿ƒè€…ã§ã‚‚å§‹ã‚ã‚„ã™ã„1é€±é–“ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ©ãƒ³ï¼ˆé‹å‹•æ™‚é–“ã¨ç¨®é¡ï¼‰ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚ææ¡ˆã¯Markdownå½¢å¼ã§æ•´å½¢ã—ã€ä»¥ä¸‹ã®2ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§æ§‹æˆã—ã¦ãã ã•ã„: 1. çŒ®ç«‹ãƒ—ãƒ©ãƒ³, 2. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ©ãƒ³. ææ¡ˆã®å†’é ­ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®BMIã«åŸºã¥ã„ãŸç¾åœ¨ã®ä½“å‹è©•ä¾¡ã¨ã€ç›®æ¨™é”æˆã®ãŸã‚ã®ã‚«ãƒ­ãƒªãƒ¼ç›®å®‰ã‚‚ç¤ºã—ã¦ãã ã•ã„ã€‚";
            const userQuery = `ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ã„ã¦ã€ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚
- èº«é•·: ${height}cm
- ä½“é‡: ${weight}kg
- æ—¥å¸¸ç”Ÿæ´»: ${activity}
- ç†æƒ³ã®ä½“å‹ãƒ»ç›®æ¨™: ${ideal}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // æŒ‡æ•°é–¢æ•°çš„ãƒãƒƒã‚¯ã‚ªãƒ•ã®å®Ÿè£…
            const MAX_RETRIES = 5;
            let lastError = null;

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                        // 429 Too Many Requests ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    const result = await response.json();

                    if (response.ok) {
                        const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (generatedText) {
                            // æˆåŠŸã—ãŸå ´åˆã€Geminiã®å›ç­”ã‚’Markdownã¨ã—ã¦è¡¨ç¤º
                            outputDiv.innerHTML = formatMarkdownToHtml(generatedText);
                            outputDiv.scrollTop = 0; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸Šã«æˆ»ã™
                            setLoadingState(false);
                            return;
                        } else {
                            throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã—ãŸã€‚");
                        }
                    } else {
                        // ãã®ä»–ã®APIã‚¨ãƒ©ãƒ¼
                        const errorMessage = result.error?.message || JSON.stringify(result);
                        throw new Error(`APIã‚¨ãƒ©ãƒ¼ (${response.status}): ${errorMessage}`);
                    }
                } catch (error) {
                    console.error(`Fetch Error (Attempt ${attempt + 1}):`, error);
                    lastError = error;
                    if (attempt === MAX_RETRIES - 1) {
                        // æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ãŸå ´åˆ
                        alertUser(`ãƒ—ãƒ©ãƒ³ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${lastError.message}`);
                        setLoadingState(false);
                        return;
                    }
                    // ãƒªãƒˆãƒ©ã‚¤ã®ãŸã‚ã®å¾…æ©Ÿ
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // ----------------------------------------------------------------------------------
        // ç°¡æ˜“Markdown to HTMLå¤‰æ› (Markdownã®æ•´å½¢çµæœã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹ãŸã‚)
        // ----------------------------------------------------------------------------------
        function formatMarkdownToHtml(markdownText) {
            let html = markdownText;

            // è¦‹å‡ºã—ã®å¤‰æ›
            html = html.replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mt-4 mb-2 text-blue-800">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-6 mb-3 text-blue-700 border-b-2 border-cyan-400 pb-1">$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1 class="text-2xl font-extrabold mt-8 mb-4 text-blue-900">$1</h1>');

            // å¼·èª¿ã®å¤‰æ›
            html = html.replace(/\*\*(.*?)\*\*/gim, '<strong class="font-semibold text-blue-600">$1</strong>');
            html = html.replace(/\*(.*?)\*/gim, '<i>$1</i>');

            // ãƒªã‚¹ãƒˆï¼ˆé †åºãªã—ï¼‰ã®å¤‰æ› (æ”¹è¡Œã¨ãƒã‚¤ãƒ•ãƒ³ã‚’ãƒªã‚¹ãƒˆé …ç›®ã«)
            html = html.replace(/^\s*-\s+(.*$)/gim, '<li class="ml-4 list-disc text-sm">$1</li>');
            // ãƒªã‚¹ãƒˆã®å§‹ã¾ã‚Šã¨çµ‚ã‚ã‚Šã‚’ulã‚¿ã‚°ã§å›²ã‚€ (è¤‡é›‘ãªå®Ÿè£…ã‚’é¿ã‘ã‚‹ãŸã‚ç°¡æ˜“çš„ã«)
            html = html.replace(/(<li.*?>[\s\S]*?<\/li>)/g, '<ul class="mb-3">$1</ul>');
            
            // æ®µè½ã®å¤‰æ›ï¼ˆãŸã ã—ã€ã™ã§ã«Hã‚¿ã‚°ã‚„ãƒªã‚¹ãƒˆã«ãªã£ã¦ã„ã‚‹è¡Œã¯é™¤ãï¼‰
            html = html.replace(/^(?!<h|<ul|<li)(.*$)/gim, '<p class="mb-3 text-sm">$1</p>');

            // é€£ç¶šã™ã‚‹æ”¹è¡Œã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã‚‹ (ãƒ†ã‚­ã‚¹ãƒˆã®æ•´å½¢ã®ãŸã‚)
            html = html.replace(/\n\n/g, '<br><br>');
            html = html.replace(/\n/g, '<br>');
            html = html.replace(/<br><br>/g, '</p><p class="mb-3 text-sm">');
            html = html.replace(/<br>/g, '<br class="my-1"/>');
            
            // å†—é•·ãªpã‚¿ã‚°ã‚’å‰Šé™¤
            html = html.replace(/<p class="mb-3 text-sm"><\/p>/g, '');


            return `<div class="p-2">${html}</div>`;
        }
        
        // ----------------------------------------------------------------------------------
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ (alert()ã®ä»£ã‚ã‚Šã«ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«é¢¨è¡¨ç¤º)
        // ----------------------------------------------------------------------------------
        function alertUser(message) {
            outputDiv.innerHTML = `<div class="p-6 bg-red-100 text-red-700 rounded-lg border border-red-300">
                <h3 class="font-bold mb-2">ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯è­¦å‘Š</h3>
                <p>${message}</p>
            </div>`;
            initialMessage.classList.add('hidden');
            setLoadingState(false);
        }

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', () => {
            outputDiv.innerHTML = '';
            initialMessage.classList.remove('hidden');
        });

    </script>
</body>
</html>